<html>
 <head>
  <meta charset="utf-8">
  <title>MV: Freischaltung</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/css/normalize.css">
  <link rel="stylesheet" href="/css/skeleton.css">
  <link rel="stylesheet" href="/jquery-ui.min.css">
  <script type="text/javascript" src="jquery-3.4.1.min.js"></script>
  <script type="text/javascript" src="jquery-ui.min.js"></script>
  <style type="text/css">
   .field {background-color:rgba(255,255,255,.8);}
  </style>
  <script type="text/javascript">
   var FIELDS = ["givenName", "surname", "additionalAddress", "street", "cityCode", "city", "mail", "mailGuardian", "phoneNumber", "mobileNumber", "reason1", "reason2", "membershipDate", "birthDate"];
   var MEMBERSHIPS = {1: "Ordentlich", 2: "Zweitmitglied", 3: "Fördermitglied", 4: "Juristisches"};
   var GENDERS = {369: "männlich", 370: "weiblich", 371: "divers"};

   $(function() {
       $("input.memberSearch").autocomplete({
           delay: 200,
           minLength: 0,
           autoFocus: true,
           source: function(request, callback) {
               $.ajax("/find.json", {
                   data: {"query": request.term},
                   success: function(returnValue) {
                       callback(returnValue.data.map(function (item) {
                           return item.memberId + " " + item.name;
                       }));
                   },
                   error: function() {
                       callback([]);
                   },
               });
           },
           close: function() {
               var value = $(this).val();
               var memberId = value.split(" ", 2)[0];
               if ($.isNumeric(memberId)) {
                   showMember(memberId);
               }
           },
       });

       $(".activateMemberBtn").click(function () {
           var memberId = $(".memberReview").data("memberId");
           $(".activateMemberBtn").attr("disabled", true);

           $.ajax("/activate.json", {
               method: "POST",
               data: {"fileId": "{{ fileId }}", "memberId": memberId},
               success: function(returnValue) {
                   if (returnValue.success) {
                       alert("Aktivierung erfolgreich!");
                       window.location = "/search.html";
                   } else {
                       alert("Konnte das Mitglied nicht freischalten: " + returnValue.message);
                       $(".activateMemberBtn").attr("disabled", false);
                   }
               },
               error: function() {
                   alert("Konnte das Mitglied nicht freischalten");
                   $(".activateMemberBtn").attr("disabled", false);
               },
           });
       });

       $("input.memberSearch").focus();
   });

   function showMemberSearch() {
       $("input.memberSearch").attr("disabled", false).val("");

       $("div.memberSearch").show();
       $("div.memberReview").hide();
   }

   function showMember(memberId) {
       $("input.memberSearch").attr("disabled", true);

       $.ajax("/query.json", {
           data: {"memberId": memberId},
           success: function(returnValue) {
               $(".memberReview").data("memberId", memberId);

               FIELDS.forEach(function (item) {
                   $("input." + item).val(returnValue.data[item]);
               });

               $("input.membership").val(MEMBERSHIPS[returnValue.data["membership"]]);
               $("input.gender").val(GENDERS[returnValue.data["gender"]]);

               $("div.memberSearch").hide();
               $("div.memberReview").show();
           },
           error: function() {
               alert("Mitgliederdaten können nicht abgerufen werden.");
               showMemberSearch();
           },
       });
   }
  </script>
 </head>
 <body>
  <div class="container" style="max-width:1200px;">
   <h1>Überprüfung</h1>
   <p>Auf der linken Seite wird der Mitgliedsantrag angezeigt. Bitte suche auf der rechten Seite das
    entsprechende Mitglied anhand des Namens.</p>
   <div class="row">
    <div class="six columns">
     <img src="application.jpg?id={{ fileId }}" width="100%" />
    </div>
    <div class="six columns memberSearch">
     <input type="text" class="u-full-width memberSearch" />
    </div>
    <div class="three columns memberReview" style="display:none;">
     <label for="membership">Mitgliedsart</label>
     <input type="text" name="membership" class="u-full-width membership" value="" disabled="disabled" />
     <label for="givenName">Vorname</label>
     <input type="text" name="givenName" class="u-full-width givenName" value="" disabled="disabled" />
     <label for="surname">Nachname</label>
     <input type="text" name="surname" class="u-full-width surname" value="" disabled="disabled" />
     <label for="additionalAddress">Adresszusatz</label>
     <input type="text" name="additionalAddress" class="u-full-width additionalAddress" value="" disabled="disabled" />
     <label for="street">Straße</label>
     <input type="text" name="street" class="u-full-width street" value="" disabled="disabled" />
     <label for="cityCode">PLZ und Ort</label>
     <input type="text" name="cityCode" class="cityCode" value="" style="width:27%;" disabled="disabled" />
     <!-- <label for="city">Ort</label> -->
     <input type="text" name="city" class="city" value="" style="width:69%;" disabled="disabled" />
     <label for="reason1">Begründung Mitglied</label>
     <textarea name="reason1" class="u-full-width reason1" disabled="disabled"></textarea>
     <label for="reason2">Begründung Stamm</label>
     <textarea name="reason2" class="u-full-width reason2" disabled="disabled"></textarea>
    </div>
    <div class="three columns memberReview" style="display:none;">
     <label for="department">Gliederung</label>
     <input type="text" name="department" class="u-full-width department" value="" disabled="disabled" />
     <label for="birthDate">Geburtsdatum</label>
     <input type="text" name="birthDate" class="u-full-width birthDate" value="" disabled="disabled" />
     <label for="gender">Geschlecht</label>
     <input type="text" name="gender" class="u-full-width gender" value="" disabled="disabled" />
     <label for="phoneNumber">Telefonnummer</label>
     <input type="text" name="phoneNumber" class="u-full-width phoneNumber" value="" disabled="disabled" />
     <label for="mobileNumber">Mobilnummer</label>
     <input type="text" name="mobileNumber" class="u-full-width mobileNumber" value="" disabled="disabled" />
     <label for="mail">E-Mail</label>
     <input type="text" name="mail" class="u-full-width mail" value="" disabled="disabled" />
     <label for="mailGuardian">E-Mail Erziehungsberechtigte</label>
     <input type="text" name="mailGuardian" class="u-full-width mailGuardian" value="" disabled="disabled" />
     <label for="membershipDate">Unterschriftsdatum</label>
     <input type="text" name="membershipDate" class="u-full-width membershipDate" value="" disabled="disabled" />
     <button class="button-primary activateMemberBtn">Aktivieren</button>
    </div>
   </div>
  </div>
 </body>
</html>

<html>
</html>
